name: Monitor Kaduna Stock Balance

on:
  schedule:
    - cron: '*/5 * * * *'  # Runs every 5 minutes
  workflow_dispatch:  # Allows manual triggering

permissions:
  contents: write  # Allow workflow to commit and push to repository

jobs:
  process-and-monitor:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create service account credentials file
      run: |
        echo '${{ secrets.GOOGLE_SHEETS_CREDENTIALS }}' > service-account.json
      env:
        ACTIONS_STEP_DEBUG: false
    
    - name: Run data transformation
      env:
        INVENTORY_SHEET_ID: ${{ secrets.INVENTORY_SHEET_ID }}
        INVENTORY_ETL_SPREADSHEET_ID: ${{ secrets.INVENTORY_ETL_SPREADSHEET_ID }}
        ACTIONS_STEP_DEBUG: false
      run: |
        echo "Starting data transformation..."
        if python transformation.py; then
          echo "Data transformation completed successfully"
          echo "TRANSFORMATION_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "‚ùå Data transformation failed"
          echo "TRANSFORMATION_SUCCESS=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: Wait for data propagation
      if: env.TRANSFORMATION_SUCCESS == 'true'
      run: |
        echo "Waiting 30 seconds for Google Sheets data propagation..."
        sleep 30
        echo "Proceeding with monitoring"

    - name: Run monitoring script
      if: env.TRANSFORMATION_SUCCESS == 'true'
      env:
        SPACE_WEBHOOK_URL: ${{ secrets.SPACE_WEBHOOK_URL }}
        SPECIFICATION_SHEET_ID: ${{ secrets.SPECIFICATION_SHEET_ID }}
        INVENTORY_ETL_SPREADSHEET_ID: ${{ secrets.INVENTORY_ETL_SPREADSHEET_ID }}
        STATE_ENCRYPTION_KEY: ${{ secrets.STATE_ENCRYPTION_KEY }}
        BASELINE_WC_QTY: ${{ secrets.BASELINE_WC_QTY }}
        BASELINE_WC_WEIGHT: ${{ secrets.BASELINE_WC_WEIGHT }}
        BASELINE_GIZZARD_PACKS: ${{ secrets.BASELINE_GIZZARD_PACKS }}
        BASELINE_GIZZARD_WEIGHT: ${{ secrets.BASELINE_GIZZARD_WEIGHT }}
        ACTIONS_STEP_DEBUG: false
      run: |
        echo "Starting inventory monitoring..."
        python monitor_combined.py
        echo "Monitoring completed"

    - name: Run cold room cost analysis
      if: env.TRANSFORMATION_SUCCESS == 'true'
      env:
        INVENTORY_ETL_SPREADSHEET_ID: ${{ secrets.INVENTORY_ETL_SPREADSHEET_ID }}
        COLD_ROOM_ANALYSIS_SPREADSHEET_ID: ${{ secrets.COLD_ROOM_ANALYSIS_SPREADSHEET_ID }}
        BASELINE_WC_QTY: ${{ secrets.BASELINE_WC_QTY }}
        BASELINE_WC_WEIGHT: ${{ secrets.BASELINE_WC_WEIGHT }}
        BASELINE_GIZZARD_WEIGHT: ${{ secrets.BASELINE_GIZZARD_WEIGHT }}
        ACTIONS_STEP_DEBUG: false
      run: |
        echo "Starting cold room cost analysis..."
        python cold_room_cost.py
        echo "Cold room cost analysis completed"

    - name: Check for failed webhooks and state read failure alerts
      if: always()
      env:
        STATE_ENCRYPTION_KEY: ${{ secrets.STATE_ENCRYPTION_KEY }}
      run: |
        # Initialize alert flags
        echo "FAILED_WEBHOOK_ALERT=false" >> $GITHUB_ENV
        echo "STATE_READ_FAILURE_ALERT=false" >> $GITHUB_ENV

        # Check for failed webhooks (encrypted)
        if [ -f "encrypted_states/failed_webhooks.enc" ] && [ -s "encrypted_states/failed_webhooks.enc" ]; then
          echo "Checking encrypted failed webhooks..."

          # Use Python to decrypt and count failed webhooks
          WEBHOOK_CHECK_RESULT=$(python3 check_failed_webhooks.py)

          if [[ "$WEBHOOK_CHECK_RESULT" == FOUND:* ]]; then
            FAILED_COUNT=$(echo "$WEBHOOK_CHECK_RESULT" | cut -d: -f2)
            echo "FAILED_WEBHOOK_COUNT=$FAILED_COUNT" >> $GITHUB_ENV
            echo "FAILED_WEBHOOK_ALERT=true" >> $GITHUB_ENV
            echo "üìß Email alert will be sent for $FAILED_COUNT failed webhook(s)"

            # Create detailed email body with failed webhook details
            echo "Failed webhook notifications detected in Kaduna inventory monitoring system." > email_body.txt
            echo "" >> email_body.txt
            echo "Number of failed webhooks: $FAILED_COUNT" >> email_body.txt
            echo "Run ID: ${{ github.run_number }}" >> email_body.txt
            echo "Time: $(date -u)" >> email_body.txt
            echo "" >> email_body.txt
            echo "Failed webhook details:" >> email_body.txt
            echo "========================" >> email_body.txt
            if [ -f "failed_webhooks_readable.txt" ]; then
              cat failed_webhooks_readable.txt >> email_body.txt
            fi
            echo "" >> email_body.txt
            echo "This means inventory change notifications may not have been delivered to your Google Space." >> email_body.txt
          elif [[ "$WEBHOOK_CHECK_RESULT" == ERROR:* ]]; then
            echo "‚ö†Ô∏è Error checking failed webhooks: $WEBHOOK_CHECK_RESULT"
          else
            echo "No failed webhooks found"
          fi
        else
          echo "No encrypted failed webhooks file found"
        fi

        # Check for state read failure alerts
        if [ -f "encrypted_states/state_read_failure_alert.json" ] && [ -s "encrypted_states/state_read_failure_alert.json" ]; then
          echo "State read failure detected. Preparing email alert..."
          echo "STATE_READ_FAILURE_ALERT=true" >> $GITHUB_ENV
          echo "üìß Email alert will be sent for state read failure"

          # Create state read failure email body
          echo "State read failure detected in Kaduna inventory monitoring system." > state_read_failure_email_body.txt
          echo "" >> state_read_failure_email_body.txt
          echo "Run ID: ${{ github.run_number }}" >> state_read_failure_email_body.txt
          echo "Time: $(date -u)" >> state_read_failure_email_body.txt
          echo "" >> state_read_failure_email_body.txt
          echo "Issue: The monitoring system could not read/decrypt encrypted state files." >> state_read_failure_email_body.txt
          echo "Impact: No inventory change detection could be performed for this monitoring cycle." >> state_read_failure_email_body.txt
          echo "" >> state_read_failure_email_body.txt
          echo "Details:" >> state_read_failure_email_body.txt
          echo "========" >> state_read_failure_email_body.txt
          cat encrypted_states/state_read_failure_alert.json >> state_read_failure_email_body.txt
          echo "" >> state_read_failure_email_body.txt
          echo "Action Required:" >> state_read_failure_email_body.txt
          echo "- Check STATE_ENCRYPTION_KEY secret" >> state_read_failure_email_body.txt
          echo "- Verify encrypted state files are not corrupted" >> state_read_failure_email_body.txt
          echo "- Check for any changes to encryption implementation" >> state_read_failure_email_body.txt
          echo "" >> state_read_failure_email_body.txt
        else
          echo "No state read failure detected"
        fi

    - name: Send email alert for failed webhooks
      id: send_failed_webhook_email
      if: always() && env.FAILED_WEBHOOK_ALERT == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "üö® Kaduna Inventory: Failed Webhook Alert (${{ env.FAILED_WEBHOOK_COUNT }} failures)"
        to: ${{ secrets.EMAIL_RECIPIENTS }}
        from: ${{ secrets.EMAIL_SENDER }}
        body: file://email_body.txt

    - name: Clear failed webhook state after alert
      if: always() && env.FAILED_WEBHOOK_ALERT == 'true' && steps.send_failed_webhook_email.outcome == 'success'
      run: |
        rm -f encrypted_states/failed_webhooks.enc
        rm -f failed_webhooks_readable.txt
        rm -f email_body.txt

    - name: Send email alert for state read failure
      if: always() && env.STATE_READ_FAILURE_ALERT == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "üîê Kaduna Inventory: State Read Failure - Encryption Issue"
        to: ${{ secrets.EMAIL_RECIPIENTS }}
        from: ${{ secrets.EMAIL_SENDER }}
        body: file://state_read_failure_email_body.txt

 